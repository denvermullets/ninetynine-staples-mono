<div class="flex flex-col min-h-screen"
     data-controller="deck-builder"
     data-deck-builder-deck-id-value="<%= @deck.id %>"
     data-deck-builder-view-mode-value="<%= @view_mode %>"
     data-deck-builder-grouping-value="<%= @grouping %>">

  <!-- Header -->
  <div class="px-4 py-4 border-b md:px-12 border-highlight bg-foreground">
    <div class="flex flex-col gap-4 md:flex-row md:items-center md:justify-between">
      <div>
        <div class="flex items-center gap-3">
          <h1 class="text-2xl font-semibold text-white"><%= @deck.name %></h1>
          <span class="px-2 py-1 text-xs font-medium rounded bg-yellow-500/20 text-yellow-400">Build Mode</span>
        </div>
        <p class="text-sm text-grey-text"><%= @deck.description %></p>
      </div>

      <div class="flex items-center gap-3">
        <% if @deck.in_build_mode? %>
          <%= button_to 'Finalize Deck', finalize_deck_builder_path(@deck),
              method: :post,
              class: 'px-4 py-2 bg-accent-50 text-background font-medium rounded-lg hover:bg-accent-50/90 transition',
              data: { turbo_confirm: 'This will move cards from source collections. Planned cards will become "needed". Continue?' } %>
        <% end %>

        <%= link_to 'Exit Build Mode', deck_show_path(username: current_user.username, collection_id: @deck.id),
            class: 'px-4 py-2 border border-highlight rounded-lg text-grey-text hover:text-white hover:border-white transition' %>
      </div>
    </div>
  </div>

  <div class="flex flex-col flex-1 gap-4 p-4 md:flex-row md:p-8">
    <!-- Sidebar: Card Preview + Search -->
    <div class="w-full md:w-80 shrink-0 space-y-4">
      <!-- Card Preview (desktop only) -->
      <% first_card = @grouped_cards.values.flatten.first&.magic_card %>
      <div class="hidden md:block">
        <div class="overflow-hidden border rounded-xl bg-foreground border-highlight">
          <img data-deck-builder-target="cardPreview"
               src="<%= first_card&.image_large || first_card&.image_medium || '' %>"
               alt="Card preview"
               class="w-full rounded-lg <%= 'hidden' unless first_card %>" />
          <% unless first_card %>
            <div class="flex items-center justify-center h-64 text-grey-text">
              <span>Add cards to preview</span>
            </div>
          <% end %>
        </div>
      </div>

      <%= render partial: 'search_panel' %>
    </div>

    <!-- Main Content -->
    <div class="flex-1 min-w-0">
      <!-- Controls Bar -->
      <div class="flex flex-wrap items-center justify-between gap-4 p-4 mb-4 border rounded-xl bg-foreground border-highlight">
        <!-- View Mode Toggle -->
        <div class="flex items-center gap-2">
          <span class="text-sm text-grey-text">View:</span>
          <button data-deck-builder-target="viewModeList"
                  data-action="click->deck-builder#setViewMode"
                  data-mode="list"
                  class="px-3 py-1.5 text-sm border rounded-lg border-highlight text-grey-text hover:text-white transition flex items-center gap-1">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/>
            </svg>
            List
          </button>
          <button data-deck-builder-target="viewModeCard"
                  data-action="click->deck-builder#setViewMode"
                  data-mode="card"
                  class="px-3 py-1.5 text-sm border rounded-lg border-highlight text-grey-text hover:text-white transition flex items-center gap-1">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 5a1 1 0 011-1h4a1 1 0 011 1v4a1 1 0 01-1 1H5a1 1 0 01-1-1V5zM14 5a1 1 0 011-1h4a1 1 0 011 1v4a1 1 0 01-1 1h-4a1 1 0 01-1-1V5z"/>
            </svg>
            Cards
          </button>
        </div>

        <!-- Grouping Selector -->
        <div class="flex items-center gap-2">
          <span class="text-sm text-grey-text">Group:</span>
          <select data-deck-builder-target="groupingSelect"
                  data-action="change->deck-builder#changeGrouping"
                  class="px-3 py-1.5 text-sm border rounded-lg bg-background border-highlight text-grey-text focus:border-accent-50 focus:outline-none">
            <option value="type" <%= 'selected' if @grouping == 'type' %>>Type</option>
            <option value="mana_value" <%= 'selected' if @grouping == 'mana_value' %>>Mana Value</option>
            <option value="color" <%= 'selected' if @grouping == 'color' %>>Color</option>
            <option value="color_identity" <%= 'selected' if @grouping == 'color_identity' %>>Color Identity</option>
            <option value="rarity" <%= 'selected' if @grouping == 'rarity' %>>Rarity</option>
            <option value="set" <%= 'selected' if @grouping == 'set' %>>Set</option>
            <option value="none" <%= 'selected' if @grouping == 'none' %>>None</option>
          </select>
        </div>

        <!-- Stats -->
        <%= turbo_frame_tag 'deck_stats' do %>
          <%= render partial: 'deck_stats' %>
        <% end %>
      </div>

      <!-- Deck Cards -->
      <%= turbo_frame_tag 'deck_cards' do %>
        <%= render partial: 'deck_cards' %>
      <% end %>
    </div>
  </div>
</div>

<div id="toasts" class="fixed bottom-4 right-4 z-50 flex flex-col gap-2"></div>
