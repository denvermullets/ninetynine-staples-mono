<%= turbo_frame_tag "deck_modal" do %>
  <dialog id="view-card-dialog"
          class="p-0 border-0 md:border rounded-none md:rounded-lg bg-foreground md:border-highlight backdrop:bg-black/50 fixed inset-0 md:inset-auto md:top-1/2 md:left-1/2 md:-translate-x-1/2 md:-translate-y-1/2 m-0 max-w-none md:max-w-[95vw] w-full h-full md:w-auto md:h-auto md:max-h-[90vh] overflow-hidden"
          data-controller="modal"
          data-action="click->modal#closeOnBackdrop keydown.esc->modal#close">
    <div class="w-full md:w-[800px] p-4 md:p-6 flex flex-col h-full md:h-auto md:max-h-[90vh]" data-modal-target="content">
      <div class="flex items-center justify-between mb-4 shrink-0">
        <h3 class="text-lg font-semibold text-grey-text"><%= magic_card.name %></h3>
        <button type="button"
                data-action="click->modal#close"
                class="text-grey-text hover:text-nine-white cursor-pointer">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
          </svg>
        </button>
      </div>

      <div class="flex flex-col md:flex-row gap-4 md:gap-6 overflow-y-auto flex-1">
        <!-- Card Image -->
        <div class="shrink-0">
          <% if magic_card.image_large.present? %>
            <img src="<%= magic_card.image_large %>"
                 alt="<%= magic_card.name %>"
                 class="w-full md:w-80 h-auto rounded-xl shadow-lg" />
          <% elsif magic_card.image_medium.present? %>
            <img src="<%= magic_card.image_medium %>"
                 alt="<%= magic_card.name %>"
                 class="w-full md:w-80 h-auto rounded-xl shadow-lg" />
          <% else %>
            <div class="flex items-center justify-center w-full md:w-80 h-64 md:h-96 rounded-xl bg-background">
              <span class="text-grey-text">No image</span>
            </div>
          <% end %>
        </div>

        <!-- Card Details -->
        <div class="flex-1 min-w-0 space-y-4">
          <!-- Status in this deck -->
          <div class="p-3 rounded-lg border border-highlight bg-background">
            <h4 class="text-sm font-semibold text-grey-text mb-2">Status in Deck</h4>
            <%
              # Build quantity breakdown for display - now all 4 types are tracked for staged cards too
              if card.staged?
                qty_regular = card.staged_quantity || 0
                qty_foil = card.staged_foil_quantity || 0
                qty_proxy = card.staged_proxy_quantity || 0
                qty_proxy_foil = card.staged_proxy_foil_quantity || 0
              else
                qty_regular = card.quantity || 0
                qty_foil = card.foil_quantity || 0
                qty_proxy = card.proxy_quantity || 0
                qty_proxy_foil = card.proxy_foil_quantity || 0
              end
              total_qty = qty_regular + qty_foil + qty_proxy + qty_proxy_foil
            %>
            <div class="text-sm">
              <% if card.staged? && card.from_owned_collection? %>
                <p class="text-blue-400 font-medium">Staged from <%= card.source_collection.name %></p>
              <% elsif card.staged? && card.planned? %>
                <p class="text-accent-400 font-medium">Planned</p>
              <% elsif card.needed? %>
                <p class="text-orange-400 font-medium">Needed</p>
              <% else %>
                <p class="text-grey-text font-medium">Owned in Deck</p>
              <% end %>
              <div class="mt-2 space-y-1 text-xs">
                <% if qty_regular > 0 %>
                  <div class="text-grey-text"><%= qty_regular %> Regular</div>
                <% end %>
                <% if qty_foil > 0 %>
                  <div class="text-grey-text"><%= qty_foil %> Foil</div>
                <% end %>
                <% if qty_proxy > 0 %>
                  <div class="text-grey-text"><%= qty_proxy %> Proxy</div>
                <% end %>
                <% if qty_proxy_foil > 0 %>
                  <div class="text-grey-text"><%= qty_proxy_foil %> Foil Proxy</div>
                <% end %>
                <div class="pt-1 mt-1 border-t border-highlight/50 text-grey-text font-medium">
                  <%= total_qty %> Total
                </div>
              </div>
            </div>
          </div>

          <!-- Card Info -->
          <div class="space-y-2">
            <div class="flex items-start gap-2">
              <span class="text-xs text-grey-text/75 w-20 shrink-0">Type:</span>
              <span class="text-sm text-grey-text"><%= magic_card.card_type %></span>
            </div>

            <% if magic_card.mana_cost.present? %>
              <div class="flex items-start gap-2">
                <span class="text-xs text-grey-text/75 w-20 shrink-0">Mana:</span>
                <span class="text-sm text-grey-text flex items-center gap-1">
                  <%= mana_symbols(magic_card.mana_cost) %>
                  <span class="text-grey-text/75 ml-1">(CMC: <%= magic_card.converted_mana_cost&.to_i || magic_card.mana_value&.to_i %>)</span>
                </span>
              </div>
            <% end %>

            <% if magic_card.text.present? %>
              <div class="flex items-start gap-2">
                <span class="text-xs text-grey-text/75 w-20 shrink-0">Text:</span>
                <span class="text-sm text-grey-text whitespace-pre-wrap"><%= card_text_with_symbols(magic_card.text) %></span>
              </div>
            <% end %>

            <% if magic_card.power.present? || magic_card.toughness.present? %>
              <div class="flex items-start gap-2">
                <span class="text-xs text-grey-text/75 w-20 shrink-0">P/T:</span>
                <span class="text-sm text-grey-text"><%= magic_card.power %>/<%= magic_card.toughness %></span>
              </div>
            <% end %>

            <% if magic_card.flavor_text.present? %>
              <div class="flex items-start gap-2">
                <span class="text-xs text-grey-text/75 w-20 shrink-0">Flavor:</span>
                <span class="text-sm text-grey-text/75 italic"><%= magic_card.flavor_text %></span>
              </div>
            <% end %>
          </div>

          <!-- Set & Pricing -->
          <div class="p-3 rounded-lg border border-highlight bg-background">
            <div class="grid grid-cols-2 gap-2 text-sm">
              <div>
                <span class="text-grey-text/75">Set:</span>
                <span class="text-grey-text ml-1"><%= magic_card.boxset&.name %></span>
              </div>
              <div>
                <span class="text-grey-text/75">Code:</span>
                <span class="text-grey-text ml-1"><%= magic_card.boxset&.code&.upcase %></span>
              </div>
              <div>
                <span class="text-grey-text/75">Rarity:</span>
                <span class="text-grey-text ml-1 capitalize"><%= magic_card.rarity %></span>
              </div>
              <div>
                <span class="text-grey-text/75">Number:</span>
                <span class="text-grey-text ml-1">#<%= magic_card.card_number %></span>
              </div>
              <div>
                <span class="text-grey-text/75">Normal:</span>
                <span class="text-grey-text ml-1"><%= number_to_currency(magic_card.normal_price) %></span>
              </div>
              <div>
                <span class="text-grey-text/75">Foil:</span>
                <span class="text-grey-text ml-1"><%= number_to_currency(magic_card.foil_price) %></span>
              </div>
              <% if magic_card.edhrec_rank.present? %>
                <div>
                  <span class="text-grey-text/75">EDHREC:</span>
                  <span class="text-grey-text ml-1">#<%= number_with_delimiter(magic_card.edhrec_rank) %></span>
                </div>
              <% end %>
              <% if magic_card.edhrec_saltiness.present? %>
                <div>
                  <span class="text-grey-text/75">Salt:</span>
                  <span class="text-grey-text ml-1"><%= format('%.2f', magic_card.edhrec_saltiness.to_f) %></span>
                </div>
              <% end %>
            </div>
          </div>

          <!-- Your Copies -->
          <% if user_copies.any? %>
            <div class="p-3 rounded-lg border border-highlight bg-background">
              <h4 class="text-sm font-semibold text-grey-text mb-2">Your Copies (All Printings)</h4>
              <div class="space-y-2 max-h-40 overflow-y-auto">
                <% user_copies.each do |copy| %>
                  <div class="flex items-center justify-between text-sm py-1 border-b border-highlight/50 last:border-0">
                    <div>
                      <span class="text-accent-50"><%= copy.collection.name %></span>
                      <span class="text-grey-text/75 text-xs ml-1">(<%= copy.magic_card.boxset&.code&.upcase %>)</span>
                    </div>
                    <div class="text-grey-text text-xs">
                      <%
                        parts = []
                        parts << "#{copy.quantity} regular" if copy.quantity > 0
                        parts << "#{copy.foil_quantity} foil" if copy.foil_quantity > 0
                        parts << "#{copy.proxy_quantity} proxy" if (copy.proxy_quantity || 0) > 0
                        parts << "#{copy.proxy_foil_quantity} foil proxy" if (copy.proxy_foil_quantity || 0) > 0
                      %>
                      <%= parts.join(', ') %>
                    </div>
                  </div>
                <% end %>
              </div>
            </div>
          <% else %>
            <div class="p-3 rounded-lg border border-highlight/50 bg-background/50">
              <p class="text-sm text-grey-text/75">You don't own any copies of this card.</p>
            </div>
          <% end %>
        </div>
      </div>

      <div class="flex justify-end pt-4 mt-4 border-t border-highlight shrink-0">
        <button type="button"
                data-action="click->modal#close"
                class="px-4 py-2 text-sm transition border rounded-md border-highlight text-grey-text hover:bg-foreground hover:text-accent-50 hover:border-accent-50 cursor-pointer">
          Close
        </button>
      </div>
    </div>
  </dialog>
<% end %>
