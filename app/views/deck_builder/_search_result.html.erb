<div class="p-3 border rounded-lg border-highlight hover:border-accent-50/50 transition"
     data-controller="add-card"
     data-add-card-deck-id-value="<%= @deck.id %>"
     data-add-card-card-id-value="<%= result[:card].id %>">

  <div class="flex items-start gap-3">
    <% if result[:card].image_small.present? %>
      <img src="<%= result[:card].image_small %>"
           alt="<%= result[:card].name %>"
           class="w-12 h-auto rounded"
           loading="lazy" />
    <% end %>

    <div class="flex-1 min-w-0">
      <h4 class="font-medium text-grey-text truncate"><%= result[:card].name %></h4>
      <p class="text-xs text-grey-text truncate"><%= result[:card].card_type %></p>

      <% if result[:already_in_deck] %>
        <span class="inline-block px-2 py-1 mt-2 text-xs rounded bg-highlight text-grey-text">
          Already in deck
        </span>
      <% else %>
        <!-- Owned copies section -->
        <%
          available_copies = result[:owned_copies].select do |owned|
            (owned[:available_quantity] + owned[:proxy_quantity]) > 0 ||
            (owned[:available_foil_quantity] + owned[:proxy_foil_quantity]) > 0
          end
          first_copy = available_copies.first
          first_max = first_copy ? first_copy[:available_quantity] + first_copy[:proxy_quantity] : 1
        %>
        <% if available_copies.any? %>
          <div class="mt-3">
            <label class="text-xs text-grey-text">Add from collection:</label>
            <select data-add-card-target="sourceSelect"
                    data-action="change->add-card#updateAvailability"
                    class="w-full px-2 py-1.5 mt-1 text-xs border rounded bg-background border-highlight text-white cursor-pointer">
              <% available_copies.each do |owned| %>
                <%
                  total_available = owned[:available_quantity] + owned[:proxy_quantity]
                  total_foil_available = owned[:available_foil_quantity] + owned[:proxy_foil_quantity]
                %>
                <option value="<%= owned[:collection_id] %>"
                        data-max-quantity="<%= total_available %>"
                        data-max-foil-quantity="<%= total_foil_available %>"
                        data-regular-quantity="<%= owned[:available_quantity] %>"
                        data-regular-foil-quantity="<%= owned[:available_foil_quantity] %>"
                        data-proxy-quantity="<%= owned[:proxy_quantity] %>"
                        data-proxy-foil-quantity="<%= owned[:proxy_foil_quantity] %>">
                  <%= owned[:collection_name] %> (<%= total_available %> avail<%= ", #{owned[:proxy_quantity]} proxy" if owned[:proxy_quantity] > 0 %>)
                </option>
              <% end %>
            </select>

            <div class="flex items-center gap-2 mt-2">
              <div class="flex items-center">
                <button type="button"
                        data-action="click->add-card#decrementQuantity"
                        class="w-8 h-8 flex items-center justify-center text-sm border rounded-l border-highlight text-grey-text hover:text-white hover:bg-background transition cursor-pointer">-</button>
                <input type="number"
                       data-add-card-target="quantityInput"
                       value="1" min="1" max="<%= first_max %>"
                       class="w-12 h-8 px-1 text-sm text-center border-y bg-background border-highlight text-white" />
                <button type="button"
                        data-action="click->add-card#incrementQuantity"
                        class="w-8 h-8 flex items-center justify-center text-sm border rounded-r border-highlight text-grey-text hover:text-white hover:bg-background transition cursor-pointer">+</button>
              </div>
              <button type="button"
                      data-add-card-target="addOwnedButton"
                      data-action="click->add-card#addOwned"
                      class="flex-1 px-3 py-1.5 text-xs rounded bg-accent-50 text-grey-text font-medium border border-accent-50 hover:bg-foreground hover:text-accent-50 transition cursor-pointer">
                Add
              </button>
            </div>
          </div>
        <% end %>

        <!-- Planned card section -->
        <div class="mt-3 pt-3 <%= available_copies.any? ? 'border-t border-highlight' : '' %>">
          <% unless available_copies.any? %>
            <div class="flex items-center gap-2">
              <div class="flex items-center">
                <button type="button"
                        data-action="click->add-card#decrementQuantity"
                        class="w-8 h-8 flex items-center justify-center text-sm border rounded-l border-highlight text-grey-text hover:text-white hover:bg-background transition cursor-pointer">-</button>
                <input type="number"
                       data-add-card-target="quantityInput"
                       value="1" min="1" max="99"
                       class="w-12 h-8 px-1 text-sm text-center border-y bg-background border-highlight text-white" />
                <button type="button"
                        data-action="click->add-card#incrementQuantity"
                        class="w-8 h-8 flex items-center justify-center text-sm border rounded-r border-highlight text-grey-text hover:text-white hover:bg-background transition cursor-pointer">+</button>
              </div>
            </div>
          <% end %>

          <button data-add-card-target="addPlannedButton"
                  data-action="click->add-card#addPlanned"
                  class="w-full px-2 py-1.5 mt-2 text-xs border rounded border-yellow-500/50 text-yellow-400 hover:bg-yellow-500/10 transition cursor-pointer">
            <% if available_copies.any? %>
              Or Add as Planned
            <% else %>
              Add as Planned
            <% end %>
          </button>
        </div>
      <% end %>
    </div>
  </div>
</div>
