<div class="flex items-start gap-4 md:gap-8 px-4 md:px-24 py-4 md:py-8" data-controller="collection-sidebar">
  <!-- Mobile Filter Button -->
  <button
    data-action="click->collection-sidebar#toggle"
    class="md:hidden fixed bottom-6 right-6 z-50 flex items-center justify-center w-14 h-14 bg-highlight text-white rounded-full shadow-lg cursor-pointer focus:outline-none"
    aria-label="Toggle filters"
  >
    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z" />
    </svg>
  </button>

  <!-- Sidebar Overlay for Mobile -->
  <div
    data-collection-sidebar-target="overlay"
    data-action="click->collection-sidebar#close"
    class="hidden fixed inset-0 bg-black bg-opacity-50 z-40 md:hidden"
  ></div>

  <!-- Sidebar -->
  <div
    data-collection-sidebar-target="sidebar"
    class="hidden md:flex flex-col shrink-0 h-auto px-4 md:px-8 py-3 md:py-4 gap-3 md:gap-8 border w-[85vw] md:w-72 max-w-sm md:max-w-none rounded-3xl md:rounded-3xl border-highlight bg-foreground text-grey-text fixed md:relative inset-y-0 left-0 z-40 md:z-auto overflow-y-auto max-h-screen"
  >
    <%= render partial: 'shared/cards/search', locals: { search_path: load_collection_path(collection_type: @collection_type) } %>
    <%= render partial: 'shared/cards/dropdown', locals: { options: @options.to_json, filter_path: load_collection_path(collection_type: @collection_type) } %>
    <div class='flex flex-col space-y-2'>
      <div>
        <%= @collection_type&.capitalize&.pluralize || 'Collections' %>
      </div>
      <% @collections.each do |collection| %>
        <% show_path = @collection_type == 'deck' ? deck_show_path(username: params[:username], collection_id: collection.id) : collection_show_path(username: params[:username], collection_id: collection.id) %>
        <%= render partial: 'binder',
                 locals: {
                   name: collection.name,
                   description: collection.description,
                   card: collection.magic_cards.count.zero? ? MagicCard.last : collection.magic_cards.last,
                   link: show_path,
                   active: collection.id == params[:collection_id].to_i
                 }
        %>
      <% end %>
      <% if current_user %>
        <%= render partial: 'binder',
                 locals: {
                   name: 'Create a Collection',
                   description: 'All this could be yours',
                   card: MagicCard.first,
                   link: new_collection_path,
                   active: false
                 }
        %>
      <% end %>
    </div>
  </div>
  <!-- Main Content -->
  <div class="flex flex-col grow gap-8">
    <!-- Top Bar -->
    <div class="shrink-0 px-6 py-4 border rounded-3xl bg-foreground border-highlight text-grey-text">
      <% if @collection.present? %>
        <div class='flex flex-row gap-4'>
          <%= render partial: 'stats',
                   locals: {
                     message: "Total cards in #{@collection.name} #{@collection_type}",
                     count: @collection.total_foil_quantity + @collection.total_quantity,
                     value: nil
                   }
          %>
          <%= render partial: 'stats',
                   locals: {
                     message: "Total value in #{@collection.name} #{@collection_type}",
                     count: nil,
                     value: @collection.total_value
                   }
          %>
          <%= render partial: 'stats',
                   locals: {
                     message: "Total value in all collections",
                     count: nil,
                     value: @collections_value
                   }
          %>
          <% if @collection_history.present? && @collection_history.any? %>
            <%= render partial: 'collection_history_chart',
                     locals: {
                       title: "#{@collection.name} value history",
                       history: @collection_history
                     }
            %>
          <% end %>
        </div>
      <% else %>
        <div class='flex flex-row gap-4'>
          <%= render partial: 'stats',
                   locals: {
                     message: "Total value in #{@collections.first.name} #{@collection_type}",
                     count: nil,
                     value: @collections.first.total_value
                   }
          %>
          <%= render partial: 'stats',
                   locals: {
                     message: "Total value in all collections",
                     count: nil,
                     value: @collections_value
                   }
          %>
          <% if @collection_history.present? && @collection_history.any? %>
            <%= render partial: 'collection_history_chart',
                     locals: {
                       title: "All collections value history",
                       history: @collection_history
                     }
            %>
          <% end %>
        </div>
      <% end %>
    </div>
    <!-- Table Content -->
    <div class="grow">
      <%= turbo_frame_tag 'boxset_content' do %>
        <div id="table-container" class="min-w-full">
          <%= render partial: 'table' %>
        </div>
      <% end %>
    </div>
  </div>
</div>
