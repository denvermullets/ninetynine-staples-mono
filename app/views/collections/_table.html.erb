<% visible_column_count = %w[card_number name type mana regular_price foil_price salt].count { |k| column_visible?(k, 'collections') } %>

<!-- Mobile Card View -->
<div class="md:hidden mb-24 max-w-full">
  <% @magic_cards.each do |card| %>
    <%= render partial: 'shared/cards/mobile_card', locals: { card: card } %>
  <% end %>

  <% if @pagy %>
    <div
      class="
        flex flex-col gap-2 w-full px-4 py-3 mt-2 bg-foreground text-sm
        rounded-xl
      "
    >
      <div class="text-grey-text"><%== @pagy.info_tag() %></div>

      <div class="overflow-x-auto">
        <%== @pagy.series_nav(link_extra: 'data-turbo-stream="true"') %>
      </div>
    </div>
  <% end %>
</div>

<!-- Desktop Table View -->
<div class="hidden md:block mb-24 overflow-x-auto border rounded-3xl border-highlight">
  <table class="min-w-full divide-y table-auto divide-background">
    <thead class="bg-background">
      <tr>
        <% if column_visible?('card_number', 'collections') %>
          <th
            class="
              py-3 pl-4 pr-0 text-xs font-normal tracking-wider text-left
              normal-case text-grey-text
            "
          >
            #
          </th>
        <% end %>

        <% if column_visible?('name', 'collections') %>
          <th
            class="
              px-4 py-2 text-xs font-normal tracking-wider text-left
              normal-case text-grey-text
            "
          >
            Name
          </th>
        <% end %>

        <% if column_visible?('type', 'collections') %>
          <th
            class="
              hidden px-4 py-2 text-xs font-normal tracking-wider text-left
              normal-case text-grey-text lg:table-cell
            "
          >
            Type
          </th>
        <% end %>

        <% if column_visible?('mana', 'collections') %>
          <th
            class="
              px-4 py-2 text-xs font-normal tracking-wider text-left
              normal-case text-grey-text
            "
          >
            Mana
          </th>
        <% end %>

        <% if column_visible?('regular_price', 'collections') %>
          <th
            class="
              px-4 py-2 text-xs font-normal tracking-wider text-left
              normal-case text-grey-text
            "
          >
            Regular
          </th>
        <% end %>

        <% if column_visible?('foil_price', 'collections') %>
          <th
            class="
              px-4 py-2 text-xs font-normal tracking-wider text-left
              normal-case text-grey-text
            "
          >
            Foil
          </th>
        <% end %>

        <% if column_visible?('salt', 'collections') %>
          <th
            class="
              hidden px-4 py-2 text-xs font-normal tracking-wider text-left
              normal-case lg:table-cell text-grey-text
            "
          >
            Salt
          </th>
        <% end %>
      </tr>
    </thead>

    <tbody class="bg-background" data-controller="expandable-row">
      <% @magic_cards.each do |card| %>
        <% trends = card.price_trend %>
        <% has_foil_in_collection = card.respond_to?(:foil_quantity) && card.foil_quantity.to_i > 0 %>
        <% has_normal_in_collection = card.respond_to?(:quantity) && card.quantity.to_i > 0 %>

        <tr
          data-action="click->expandable-row#toggle"
          data-card-id="<%= card.id %>"
          class="
            border border-background text-grey-text bg-foreground
            hover:bg-menu hover:cursor-pointer
          "
        >
          <% if column_visible?('card_number', 'collections') %>
            <td class="pl-4 pr-0 text-sm py-7 whitespace-nowrap">
              <%= card.card_number %>
            </td>
          <% end %>

          <% if column_visible?('name', 'collections') %>
            <td class="px-4 py-2 text-sm whitespace-nowrap">
              <i class="drop-shadow-nine py-1 rounded-xl ss ss-grad ss-<%= card.boxset.keyrune_code.downcase %> ss-<%= card.rarity.downcase %> ss-fw ss-2x mr-4"></i>
              <%= card.name %>

              <% if card.etched_finish? %>
                <span
                  class="
                    ml-2 px-1.5 py-0.5 text-xs rounded bg-purple-900/30
                    text-purple-400 border border-purple-500/30
                  "
                  title="Etched finish"
                >
                  E
                </span>
              <% end %>

              <% if card.is_token %>
                <span
                  class="
                    ml-2 px-1.5 py-0.5 text-xs rounded bg-amber-900/30
                    text-amber-400 border border-amber-500/30
                  "
                  title="Token"
                >
                  T
                </span>
              <% end %>
            </td>
          <% end %>

          <% if column_visible?('type', 'collections') %>
            <td class="hidden px-4 py-2 text-sm whitespace-nowrap lg:table-cell">
              <%= card.card_type %>
            </td>
          <% end %>

          <% if column_visible?('mana', 'collections') %>
            <td class="px-4 py-2 text-sm whitespace-nowrap">
              <div class="flex items-center m-0 space-x-1">
                <%= mana_symbols(card.mana_cost) %>
              </div>
            </td>
          <% end %>

          <% if column_visible?('regular_price', 'collections') %>
            <td class="px-4 py-2 text-sm whitespace-nowrap">
              <% if has_normal_in_collection %>
                <div class="flex items-center gap-2">
                  <%= number_to_currency(card.normal_price) %>

                  <% if card.price_change_weekly_normal.present? && card.price_change_weekly_normal.abs >= 0.5 %>
                    <span class="px-2 py-1 text-xs rounded-full <%= card.price_change_weekly_normal >= 0 ? 'bg-green-900/20 text-green-400' : 'bg-red-900/20 text-red-400' %>">
                      <%= card.price_change_weekly_normal >= 0 ? '↑' : '↓' %>
                      <%= number_to_percentage(card.price_change_weekly_normal.abs, precision: 0) %>
                    </span>
                  <% end %>
                </div>
              <% end %>
            </td>
          <% end %>

          <% if column_visible?('foil_price', 'collections') %>
            <td class="px-4 py-2 text-sm whitespace-nowrap">
              <% if has_foil_in_collection %>
                <div class="flex items-center gap-2">
                  <%= number_to_currency(card.foil_price) %>

                  <% if card.price_change_weekly_foil.present? && card.price_change_weekly_foil.abs >= 0.5 %>
                    <span class="px-2 py-1 text-xs rounded-full <%= card.price_change_weekly_foil >= 0 ? 'bg-green-900/20 text-green-400' : 'bg-red-900/20 text-red-400' %>">
                      <%= card.price_change_weekly_foil >= 0 ? '↑' : '↓' %>
                      <%= number_to_percentage(card.price_change_weekly_foil.abs, precision: 0) %>
                    </span>
                  <% end %>
                </div>
              <% end %>
            </td>
          <% end %>

          <% if column_visible?('salt', 'collections') %>
            <td class="hidden px-4 py-2 text-sm whitespace-nowrap lg:table-cell">
              <% if card.edhrec_saltiness.present? %>
                <%= number_with_precision(card.edhrec_saltiness, precision: 2) %>
              <% end %>
            </td>
          <% end %>
        </tr>

        <tr
          data-expandable-row-target="content"
          data-card-id="<%= card.id %>"
          class="hidden border border-background"
        >
          <td colspan="<%= visible_column_count %>">
            <%= turbo_frame_tag "card_details_#{card.id}",
                src: boxset_magic_card_path(card.id, collection_id: params[:collection_id] || nil, username: params[:username]),
                loading: :lazy %>
          </td>
        </tr>
      <% end %>
    </tbody>
  </table>

  <% if @pagy %>
    <div class="flex flex-row items-center justify-between w-full p-6 space-x-4">
      <%== @pagy.info_tag() %>
      <%== @pagy.series_nav(link_extra: 'data-turbo-stream="true"') %>
    </div>
  <% end %>
</div>
