<%# Shared card component for collections and decks
    Required locals:
      - collection: The collection/deck object
      - link_path: Path the card links to
      - is_owner: Boolean for edit permissions
    Optional locals:
      - edit_url: URL for edit modal (required if is_owner)
      - frame_id: Turbo frame ID for modal (default: 'collection_modal')
      - show_proxy_value: Boolean to show proxy value (default: false)
%>
<% frame_id = local_assigns[:frame_id] || 'collection_modal' %>
<% show_proxy_value = local_assigns[:show_proxy_value] || false %>
<% commander = collection.commanders.first&.magic_card %>
<% card = collection.magic_cards.any? ? collection.magic_cards.last : nil %>

<div class="relative"
     <% if is_owner && local_assigns[:edit_url] %>
     data-controller="context-menu"
     data-context-menu-edit-url-value="<%= edit_url %>"
     data-context-menu-frame-id-value="<%= frame_id %>"
     data-action="contextmenu->context-menu#open"
     <% end %>>
  <%= link_to link_path, class: 'group' do %>
    <div class="relative flex flex-col border rounded-2xl bg-foreground border-highlight overflow-hidden hover:border-accent-50 transition-all duration-200 hover:shadow-lg hover:shadow-accent-50/20">
      <!-- Card Image -->
      <div class="relative h-48 bg-background overflow-hidden">
        <% if commander %>
          <img
            src="<%= commander.art_crop.presence || commander.image_large %>"
            alt="<%= commander.name %>"
            class="w-full h-full object-cover object-top group-hover:scale-105 transition-transform duration-200"
          />
        <% elsif card %>
          <img
            src="<%= card.art_crop.presence || card.image_large %>"
            alt="<%= card.name %>"
            class="w-full h-full object-cover object-top group-hover:scale-105 transition-transform duration-200"
          />
        <% else %>
          <div class="w-full h-full flex items-center justify-center">
            <span class="text-grey-text text-4xl">?</span>
          </div>
        <% end %>

        <% if collection.in_build_mode? %>
          <!-- Staged Cards Badge -->
          <div class="absolute top-2 left-2 px-2 py-1 bg-accent-400 text-foreground text-xs font-medium rounded">
            <%= collection.staged_cards_count %> staged
          </div>

          <!-- Build Mode Badge -->
          <div class="absolute top-2 right-2 px-2 py-1 bg-accent-400 text-foreground text-xs font-medium rounded">
            Building
          </div>
        <% end %>

        <!-- Type Badge -->
        <div class="absolute bottom-2 left-2 px-2 py-1 bg-background/80 text-grey-text text-xs rounded">
          <%= collection.collection_type&.titleize&.gsub('_', ' ') || 'Collection' %>
        </div>

        <% if is_owner && collection.hidden? %>
          <!-- Private Badge -->
          <div class="absolute bottom-2 right-2 px-2 py-1 bg-background/80 text-grey-text text-xs rounded flex items-center gap-1">
            <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"/>
            </svg>
            Private
          </div>
        <% end %>
      </div>

      <!-- Info -->
      <div class="p-4 flex flex-col h-36">
        <h3 class="text-grey-text font-medium truncate"><%= collection.name %></h3>

        <% if commander %>
          <p class="text-grey-text text-sm truncate mt-1"><%= commander.name %></p>
        <% elsif collection.description.present? %>
          <p class="text-grey-text text-sm truncate mt-1"><%= collection.description %></p>
        <% else %>
          <p class="text-grey-text text-sm mt-1">&nbsp;</p>
        <% end %>

        <div class="flex flex-wrap gap-1 min-h-6 mt-2">
          <% collection.tags.each do |tag| %>
            <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium <%= tag_text_color_class(tag.color) %>"
                  style="background-color: <%= tag.color %>;">
              <%= tag.name %>
            </span>
          <% end %>
        </div>

        <div class="flex items-center justify-between text-sm text-grey-text mt-auto">
          <span><%= collection.total_cards %> cards</span>
          <div class="flex items-center gap-1.5">
            <span>$<%= number_with_precision(collection.total_value || 0, precision: 2, delimiter: ',') %></span>
            <% if show_proxy_value && collection.proxy_total_value.to_f > 0 %>
              <span class="text-grey-text/70">//</span>
              <span>$<%= number_with_precision(collection.proxy_total_value, precision: 2, delimiter: ',') %></span>
              <span class="px-1 py-0.5 text-xs font-bold rounded bg-accent-400/20 text-accent-400 border border-accent-400/30" title="Proxy Value">P</span>
            <% end %>
          </div>
        </div>
      </div>
    </div>
  <% end %>

  <% if is_owner && local_assigns[:edit_url] %>
    <!-- Context Menu -->
    <div data-context-menu-target="menu"
         class="hidden fixed z-50 min-w-[120px] py-1 bg-foreground border border-highlight rounded-lg shadow-lg">
      <button type="button"
              data-action="click->context-menu#edit"
              class="w-full px-4 py-2 text-left text-sm text-grey-text hover:bg-background hover:text-white transition cursor-pointer">
        Edit
      </button>
    </div>
  <% end %>
</div>
