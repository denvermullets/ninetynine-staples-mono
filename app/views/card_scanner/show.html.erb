<div class="flex flex-col lg:flex-row gap-4 lg:gap-8 px-4 md:px-24 py-4 md:py-8"
     data-controller="card-scanner"
     data-card-scanner-search-path-value="<%= card_scanner_search_path %>"
     data-card-scanner-add-path-value="<%= card_scanner_add_path %>"
     data-card-scanner-auto-mode-value="true">

  <!-- Left Column: Camera & Controls -->
  <div class="flex flex-col gap-4 lg:w-1/2">
    <!-- Collection Selector -->
    <div class="px-6 py-4 border rounded-3xl bg-foreground border-highlight text-grey-text">
      <label class="block text-sm font-medium mb-2">Add cards to:</label>
      <% if @collections.any? %>
        <select data-card-scanner-target="collectionSelect"
                class="w-full px-3 py-2 bg-background border border-highlight rounded-lg text-grey-text focus:outline-none focus:ring-2 focus:ring-accent-50">
          <% @collections.each do |collection| %>
            <option value="<%= collection.id %>"><%= collection.name %></option>
          <% end %>
        </select>
      <% else %>
        <p class="text-accent-100">
          You need to <%= link_to 'create a collection', new_collection_path, class: 'underline hover:text-white' %> first.
        </p>
      <% end %>
    </div>

    <!-- Camera Section -->
    <div class="px-6 py-4 border rounded-3xl bg-foreground border-highlight text-grey-text">
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-lg font-semibold text-white">Card Scanner</h2>

        <!-- Auto Mode Toggle -->
        <button data-card-scanner-target="autoModeToggle"
                data-action="click->card-scanner#toggleAutoMode"
                class="flex items-center gap-2 px-3 py-1 rounded-full text-xs bg-accent-50 text-menu transition cursor-pointer">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" />
          </svg>
          Auto
        </button>
      </div>

      <!-- Status Message -->
      <p data-card-scanner-target="status" class="text-sm mb-4 text-grey-text/70">
        Click "Start Camera" to begin scanning cards.
      </p>

      <!-- Error Message -->
      <div data-card-scanner-target="cameraError"
           class="hidden mb-4 p-3 bg-red-500/10 border border-red-500/30 rounded-lg text-red-400 text-sm">
      </div>

      <!-- Camera Container -->
      <div data-card-scanner-target="cameraContainer" class="hidden relative aspect-[4/3] bg-black rounded-lg overflow-hidden mb-4">
        <video data-card-scanner-target="video"
               autoplay
               playsinline
               muted
               class="w-full h-full object-cover">
        </video>

        <!-- Card Guide Overlay (Magic card aspect ratio) -->
        <div data-card-scanner-target="cardGuide"
             class="absolute border-2 border-accent-50 rounded-lg pointer-events-none shadow-lg"
             style="box-shadow: 0 0 0 9999px rgba(0,0,0,0.5);">
          <!-- Corner markers -->
          <div class="absolute top-0 left-0 w-4 h-4 border-t-2 border-l-2 border-white rounded-tl"></div>
          <div class="absolute top-0 right-0 w-4 h-4 border-t-2 border-r-2 border-white rounded-tr"></div>
          <div class="absolute bottom-0 left-0 w-4 h-4 border-b-2 border-l-2 border-white rounded-bl"></div>
          <div class="absolute bottom-0 right-0 w-4 h-4 border-b-2 border-r-2 border-white rounded-br"></div>

          <!-- Name region indicator (top 15%) -->
          <div class="absolute top-0 left-0 right-0 h-[15%] border-b border-dashed border-accent-50/50 bg-accent-50/10">
            <span class="absolute top-1 left-2 text-[10px] text-accent-50/70">Name</span>
          </div>

          <!-- Set region indicator (bottom 10%, left 40%) -->
          <div class="absolute bottom-0 left-0 w-[40%] h-[10%] border-t border-r border-dashed border-accent-50/50 bg-accent-50/10">
            <span class="absolute bottom-1 left-2 text-[10px] text-accent-50/70">Set</span>
          </div>
        </div>

        <!-- Stability Indicator -->
        <div class="absolute bottom-2 left-2 right-2">
          <div class="w-full bg-black/50 rounded-full h-1.5">
            <div data-card-scanner-target="stabilityIndicator"
                 class="bg-accent-50 h-1.5 rounded-full transition-all duration-100"
                 style="width: 0%">
            </div>
          </div>
        </div>
      </div>

      <!-- Preview Container -->
      <div data-card-scanner-target="preview" class="hidden mb-4">
        <img data-card-scanner-target="previewImage"
             alt="Captured card"
             class="w-full aspect-[4/3] object-cover rounded-lg">
      </div>

      <!-- Hidden Canvases for OCR Processing -->
      <canvas data-card-scanner-target="canvas" class="hidden"></canvas>
      <canvas data-card-scanner-target="nameCanvas" class="hidden"></canvas>
      <canvas data-card-scanner-target="setCanvas" class="hidden"></canvas>

      <!-- Progress Bar -->
      <div data-card-scanner-target="progress" class="hidden mb-4">
        <div class="flex justify-between text-xs mb-1">
          <span>Processing...</span>
          <span data-card-scanner-target="progressText">0%</span>
        </div>
        <div class="w-full bg-background rounded-full h-2">
          <div data-card-scanner-target="progressBar"
               class="bg-accent-50 h-2 rounded-full transition-all duration-300"
               style="width: 0%">
          </div>
        </div>
      </div>

      <!-- Loading Indicator -->
      <div data-card-scanner-target="loading" class="hidden mb-4 text-center">
        <div class="inline-flex items-center gap-2">
          <svg class="animate-spin h-5 w-5 text-accent-50" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
          </svg>
          <span>Processing image...</span>
        </div>
      </div>

      <!-- Controls -->
      <div class="flex flex-wrap gap-2">
        <button data-action="click->card-scanner#startCamera"
                class="px-4 py-2 bg-accent-50 text-menu rounded-lg hover:bg-accent-50/80 transition cursor-pointer">
          Start Camera
        </button>

        <button data-card-scanner-target="captureButton"
                data-action="click->card-scanner#capture"
                class="hidden px-4 py-2 bg-highlight text-white rounded-lg hover:bg-highlight/80 transition cursor-pointer">
          Capture Image
        </button>

        <button data-card-scanner-target="scanButton"
                data-action="click->card-scanner#scan"
                class="hidden px-4 py-2 bg-accent-50 text-menu rounded-lg hover:bg-accent-50/80 transition cursor-pointer">
          Scan Text
        </button>

        <button data-card-scanner-target="retakeButton"
                data-action="click->card-scanner#retake"
                class="hidden px-4 py-2 border border-highlight text-grey-text rounded-lg hover:bg-background transition cursor-pointer">
          Scan Next
        </button>
      </div>

      <!-- Tips -->
      <div class="mt-6 p-4 bg-background/50 rounded-lg">
        <h3 class="text-sm font-medium mb-2 text-white">Tips for best results:</h3>
        <ul class="text-xs text-grey-text/70 space-y-1">
          <li>- Position the card within the guide overlay</li>
          <li>- Ensure good, even lighting (avoid glare)</li>
          <li>- Hold the card steady - auto-capture triggers when stable</li>
          <li>- Make sure the card name and set info are visible</li>
        </ul>
      </div>
    </div>

    <!-- Debug Panel -->
    <div data-card-scanner-target="debugPanel" class="hidden px-6 py-4 border rounded-3xl bg-foreground border-highlight text-grey-text">
      <h3 class="text-sm font-semibold mb-3 text-white flex items-center gap-2">
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4" />
        </svg>
        OCR Debug Info
      </h3>
      <div class="space-y-3 text-xs font-mono">
        <div>
          <span class="text-grey-text/50">Name Region (raw):</span>
          <div data-card-scanner-target="debugNameText" class="mt-1 p-2 bg-background rounded text-grey-text break-all whitespace-pre-wrap"></div>
        </div>
        <div>
          <span class="text-grey-text/50">Set Region (raw):</span>
          <div data-card-scanner-target="debugSetText" class="mt-1 p-2 bg-background rounded text-grey-text break-all whitespace-pre-wrap"></div>
        </div>
        <div class="flex gap-4">
          <div>
            <span class="text-grey-text/50">Parsed Set:</span>
            <span data-card-scanner-target="debugParsedSet" class="ml-2 text-accent-50"></span>
          </div>
          <div>
            <span class="text-grey-text/50">Parsed #:</span>
            <span data-card-scanner-target="debugParsedNumber" class="ml-2 text-accent-50"></span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Right Column: Results & History -->
  <div class="flex flex-col gap-4 lg:w-1/2">
    <!-- Search Results -->
    <div class="px-6 py-4 border rounded-3xl bg-foreground border-highlight text-grey-text">
      <h2 class="text-lg font-semibold mb-4 text-white">Search Results</h2>
      <div id="scan_results" data-card-scanner-target="results">
        <p class="text-grey-text/70 text-sm">Scan a card to see matching results.</p>
      </div>
    </div>

    <!-- Scan History -->
    <div class="px-6 py-4 border rounded-3xl bg-foreground border-highlight text-grey-text">
      <h2 class="text-lg font-semibold mb-4 text-white">Session History</h2>
      <div id="scan_history" data-card-scanner-target="scanHistory" class="space-y-2">
        <p class="text-grey-text/70 text-sm">Cards you add will appear here.</p>
      </div>
    </div>
  </div>
</div>
